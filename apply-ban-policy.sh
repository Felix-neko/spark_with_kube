#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ –±–∞–Ω–∞ Spark-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ–ª–∏—Ç–∏–∫—É –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è namespace, —Ç–∞–∫ –∫–∞–∫ —Ä–µ—Å—É—Ä—Å—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö namespace

set -e

echo "=========================================="
echo "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –±–∞–Ω–∞ Spark-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
echo "=========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "spark-app-banning-policy.yaml" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª spark-app-banning-policy.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "üìã –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É..."
kubectl apply -f spark-app-banning-policy.yaml

echo ""
echo "‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!"
echo ""

# –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Job
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ Job –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–æ–≤..."
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Job
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å Job:"
kubectl get job cleanup-banned-pods-immediate -n spark 2>/dev/null || echo "  Job –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω"

echo ""
echo "üìù –õ–æ–≥–∏ Job (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫):"
kubectl logs -n spark job/cleanup-banned-pods-immediate --tail=20 2>/dev/null || echo "  –õ–æ–≥–∏ –µ—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥:"
echo "  kubectl logs -n spark job/cleanup-banned-pods-immediate"

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–æ–≤ —Å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π:"
BANNED_PODS=$(kubectl get pods -n spark -l spark-app-name=pyspark-k8s-client -o name 2>/dev/null || true)
if [ -z "$BANNED_PODS" ]; then
    echo "  ‚úì –ü–æ–¥–æ–≤ —Å –º–µ—Ç–∫–æ–π spark-app-name=pyspark-k8s-client –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
else
    echo "  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø–æ–¥—ã (–≤–æ–∑–º–æ–∂–Ω–æ, –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —É–¥–∞–ª–µ–Ω–∏—è):"
    echo "$BANNED_PODS" | sed 's/^/    /'
fi

echo ""
echo "=========================================="
echo "–ü–æ–ª–∏—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç"
echo "=========================================="
echo ""
echo "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:"
echo "  1. ‚úÖ ClusterPolicy –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–¥–æ–≤"
echo "  2. ‚úÖ Job –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–¥–∞–ª–∏–ª —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–¥—ã"
echo "  3. ‚úÖ ClusterCleanupPolicy –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥"
echo "  4. ‚è±Ô∏è  –ß–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—Å—è"
echo ""
echo "–î–ª—è —Ä—É—á–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏:"
echo "  kubectl delete clusterpolicy deny-spark-app-pyspark-k8s-client"
echo "  kubectl delete clustercleanuppolicy cleanup-banned-spark-app"
echo ""
